import React, { useState, useEffect } from 'react';
import ApiService from '../services/apiService';
import productService from '../services/productService';
import LoadingSpinner from '../components/LoadingSpinner';
import '../styles/frontend-cashier.css';
import '../styles/global-enhancement.css';

function FrontendCashier() {
  const [searchTerm, setSearchTerm] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [selectedMember, setSelectedMember] = useState(null);
  const [isSearching, setIsSearching] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [message, setMessage] = useState({ type: '', text: '' });
  
  // å•†å“ç›¸å…³çŠ¶æ€
  const [products, setProducts] = useState([]);
  const [selectedProducts, setSelectedProducts] = useState([]);
  const [isLoadingProducts, setIsLoadingProducts] = useState(false);
  const [productSearchTerm, setProductSearchTerm] = useState('');
  const [filteredProducts, setFilteredProducts] = useState([]);
  const [activeCategory, setActiveCategory] = useState('å…¨éƒ¨');

  // åŠ è½½å•†å“åˆ—è¡¨
  useEffect(() => {
    loadProducts();
  }, []);

  // å•†å“æœç´¢è¿‡æ»¤
  useEffect(() => {
    let filtered = products;
    
    // æŒ‰åˆ†ç±»è¿‡æ»¤
    if (activeCategory !== 'å…¨éƒ¨') {
      filtered = filtered.filter(product => 
        product.fields.kind === activeCategory
      );
    }
    
    // æŒ‰æœç´¢è¯è¿‡æ»¤
    if (productSearchTerm.trim()) {
      filtered = filtered.filter(product => 
        product.fields.name?.toLowerCase().includes(productSearchTerm.toLowerCase()) ||
        product.fields.kind?.toLowerCase().includes(productSearchTerm.toLowerCase())
      );
    }
    
    setFilteredProducts(filtered);
  }, [products, activeCategory, productSearchTerm]);

  const loadProducts = async () => {
    setIsLoadingProducts(true);
    try {
      const response = await productService.getAllProducts();
      if (response.success) {
        setProducts(response.data);
        setFilteredProducts(response.data);
      } else {
        showMessage('åŠ è½½å•†å“å¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('åŠ è½½å•†å“æ—¶å‡ºé”™:', error);
      showMessage('åŠ è½½å•†å“æ—¶å‡ºé”™', 'error');
    } finally {
      setIsLoadingProducts(false);
    }
  };

  const handleSearch = async () => {
    if (!searchTerm.trim()) {
      showMessage('è¯·è¾“å…¥æœç´¢å†…å®¹', 'error');
      return;
    }

    setIsSearching(true);
    try {
      const response = await ApiService.searchMembers(searchTerm);
      if (response.success) {
        setSearchResults(response.data);
        if (response.data.length === 0) {
          showMessage('æœªæ‰¾åˆ°ç›¸å…³ä¼šå‘˜', 'error');
        }
      } else {
        showMessage('æœç´¢å¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('æœç´¢æ—¶å‡ºé”™:', error);
      showMessage('æœç´¢æ—¶å‡ºé”™', 'error');
    } finally {
      setIsSearching(false);
    }
  };

  const selectMember = (member) => {
    setSelectedMember(member);
    setSearchResults([]);
    setSearchTerm('');
  };

  const addProduct = (product) => {
    const existingProduct = selectedProducts.find(p => p.id === product.id);
    if (existingProduct) {
      setSelectedProducts(selectedProducts.map(p => 
        p.id === product.id 
          ? { ...p, quantity: p.quantity + 1 }
          : p
      ));
    } else {
      setSelectedProducts([...selectedProducts, { ...product, quantity: 1 }]);
    }
  };

  const removeProduct = (productId) => {
    setSelectedProducts(selectedProducts.filter(p => p.id !== productId));
  };

  const updateProductQuantity = (productId, quantity) => {
    if (quantity <= 0) {
      removeProduct(productId);
      return;
    }
    setSelectedProducts(selectedProducts.map(p => 
      p.id === productId 
        ? { ...p, quantity }
        : p
    ));
  };

  const calculateTotal = () => {
    return selectedProducts.reduce((total, product) => {
      const price = parseFloat(product.fields.member_price || product.fields.price || 0);
      return total + (price * product.quantity);
    }, 0);
  };

  const handleCheckout = async () => {
    if (!selectedMember) {
      showMessage('è¯·å…ˆé€‰æ‹©ä¼šå‘˜', 'error');
      return;
    }

    if (selectedProducts.length === 0) {
      showMessage('è¯·å…ˆé€‰æ‹©å•†å“', 'error');
      return;
    }

    const total = calculateTotal();
    const currentBalance = parseFloat(selectedMember.fields.balance || 0);

    if (currentBalance < total) {
      showMessage('ä¼šå‘˜ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼', 'error');
      return;
    }

    setIsProcessing(true);
    try {
      // æ‰£é™¤ä½™é¢
      const newBalance = currentBalance - total;
      const updateResponse = await ApiService.updateMember(selectedMember.id, {
        balance: newBalance
      });

      if (updateResponse.success) {
        // è®°å½•æ¶ˆè´¹
        const consumeResponse = await ApiService.recordConsumption({
          member_id: selectedMember.id,
          member_name: selectedMember.fields.name,
          amount: total,
          products: selectedProducts.map(p => ({
            name: p.fields.name,
            quantity: p.quantity,
            price: parseFloat(p.fields.member_price || p.fields.price || 0)
          })),
          balance_before: currentBalance,
          balance_after: newBalance
        });

        if (consumeResponse.success) {
          showMessage(`ç»“è´¦æˆåŠŸï¼æ¶ˆè´¹é‡‘é¢ï¼š${total.toFixed(2)}å…ƒï¼Œä½™é¢ï¼š${newBalance.toFixed(2)}å…ƒ`, 'success');
          // æ›´æ–°é€‰ä¸­ä¼šå‘˜çš„ä½™é¢
          setSelectedMember({
            ...selectedMember,
            fields: {
              ...selectedMember.fields,
              balance: newBalance
            }
          });
          // æ¸…ç©ºè´­ç‰©è½¦
          setSelectedProducts([]);
        } else {
          showMessage('è®°å½•æ¶ˆè´¹å¤±è´¥', 'error');
        }
      } else {
        showMessage('æ›´æ–°ä½™é¢å¤±è´¥', 'error');
      }
    } catch (error) {
      console.error('ç»“è´¦æ—¶å‡ºé”™:', error);
      showMessage('ç»“è´¦æ—¶å‡ºé”™', 'error');
    } finally {
      setIsProcessing(false);
    }
  };

  const showMessage = (text, type) => {
    setMessage({ text, type });
    setTimeout(() => setMessage({ text: '', type: '' }), 3000);
  };

  const clearCart = () => {
    setSelectedProducts([]);
  };

  const clearMember = () => {
    setSelectedMember(null);
    setSearchResults([]);
    setSearchTerm('');
  };

  const categories = ['å…¨éƒ¨', 'é¥®å“', 'å°é£Ÿ', 'å¥—é¤', 'å…¶ä»–'];

  return (
    <div className="frontend-cashier">
      {/* å·¦ä¾§è“è‰²å¯¼èˆªæ  */}
      <div className="sidebar">
        <div className="sidebar-header">
          <h2>å‰å°æ”¶é“¶ç³»ç»Ÿ</h2>
          <div className="system-info">
            <p>ç®¡ç†ï¼šåº—é•¿ç®¡ç†å‘˜</p>
            <p>2024/08/25 17:37:37</p>
          </div>
        </div>
        
        <div className="nav-menu">
          <div className="nav-item active">
            <div className="nav-icon">ğŸ’°</div>
            <div className="nav-content">
              <span className="nav-title">æ”¶é“¶</span>
              <span className="nav-subtitle">å•†å“é”€å”®æ”¶é“¶</span>
            </div>
          </div>
          
          <div className="nav-item">
            <div className="nav-icon">ğŸ’³</div>
            <div className="nav-content">
              <span className="nav-title">å……å€¼</span>
              <span className="nav-subtitle">ä¼šå‘˜å……å€¼æœåŠ¡</span>
            </div>
          </div>
          
          <div className="nav-item">
            <div className="nav-icon">ğŸ‘¤</div>
            <div className="nav-content">
              <span className="nav-title">åŠå¡</span>
              <span className="nav-subtitle">ä¼šå‘˜å¼€å¡åŠç†</span>
            </div>
          </div>
        </div>
        
        <div className="sidebar-footer">
          <div className="system-status">
            <p>ğŸ”— ç³»ç»Ÿåœ¨çº¿</p>
            <p>ğŸ’¾ æ•°æ®åŒæ­¥ï¼šç®¡ç†ç«¯</p>
          </div>
          
          <div className="quick-actions">
            <p>ğŸ” åˆ‡æ¢åˆ°ï¼šè¡Œæ”¿ç®¡ç†</p>
          </div>
        </div>
      </div>
      
      {/* å³ä¾§ä¸»è¦å†…å®¹åŒºåŸŸ */}
      <div className="main-content">
        {/* é¡¶éƒ¨æ ‡é¢˜æ  */}
        <div className="top-header">
          <h1>å‰å°æ”¶é“¶ç³»ç»Ÿ</h1>
          <div className="header-info">
            <span>ç®¡ç†ï¼šåº—é•¿ç®¡ç†å‘˜</span>
            <span>2024/08/25 17:37:37</span>
          </div>
        </div>
        
        {/* æœç´¢æ åŒºåŸŸ */}
        <div className="search-section">
          <div className="search-row">
            <div className="search-group member-search">
              <div className="search-icon">ğŸ“±</div>
              <input
                type="text"
                className="search-input"
                placeholder="è¯·è¾“å…¥ä¼šå‘˜å§“åæˆ–æ‰‹æœºå·"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
              />
              <button 
                className="search-btn" 
                onClick={handleSearch}
                disabled={isSearching}
              >
                {isSearching ? 'æœç´¢ä¸­...' : 'æœç´¢'}
              </button>
            </div>
            
            <div className="search-group product-search">
              <div className="search-icon">ğŸ”</div>
              <input
                type="text"
                className="search-input"
                placeholder="è¯·è¾“å…¥å•†å“ç¼–ç æˆ–åç§°"
                value={productSearchTerm}
                onChange={(e) => setProductSearchTerm(e.target.value)}
              />
            </div>
            
            <button className="add-product-btn">
              æ·»åŠ å•†å“
            </button>
          </div>
        </div>
        
        {/* ä¸»è¦å†…å®¹åŒºåŸŸ */}
        <div className="content-wrapper">
          {/* ä¼šå‘˜ä¿¡æ¯åŒºåŸŸ */}
          <div className="member-info-section">
            <h3>ä¼šå‘˜ä¿¡æ¯</h3>
            {selectedMember ? (
              <div className="member-card">
                <div className="member-header">
                  <span className="member-label">ä¼šå‘˜</span>
                  <button className="close-btn" onClick={clearMember}>Ã—</button>
                </div>
                <div className="member-details">
                  <div className="member-row">
                    <span className="label">å§“å:</span>
                    <span className="value">{selectedMember.fields.name}</span>
                  </div>
                  <div className="member-row">
                    <span className="label">é‡‘é¢:</span>
                    <span className="value">{parseFloat(selectedMember.fields.balance || 0).toFixed(0)}å…ƒ</span>
                  </div>
                  <div className="member-row">
                    <span className="label">ä½™é¢:</span>
                    <span className="value">{parseFloat(selectedMember.fields.balance || 0).toFixed(0)}å…ƒ</span>
                  </div>
                </div>
              </div>
            ) : (
              <div className="member-placeholder">
                <p>è¯·æœç´¢å¹¶é€‰æ‹©ä¼šå‘˜</p>
              </div>
            )}
          </div>
          
          {/* å•†å“é€‰æ‹©åŒºåŸŸ */}
          <div className="products-section">
            <h3>å•†å“é€‰æ‹©</h3>
            
            {/* åˆ†ç±»æ ‡ç­¾ */}
            <div className="category-tabs">
              {categories.map(category => (
                <button
                  key={category}
                  className={`category-tab ${activeCategory === category ? 'active' : ''}`}
                  onClick={() => setActiveCategory(category)}
                >
                  {category}
                </button>
              ))}
            </div>
            
            {/* å•†å“ç½‘æ ¼ */}
            {isLoadingProducts ? (
              <LoadingSpinner />
            ) : (
              <div className="products-grid">
                {filteredProducts.map(product => (
                  <div key={product.id} className="product-card">
                    <div className="product-image">
                      <div className="product-icon">ğŸ“¦</div>
                    </div>
                    <div className="product-info">
                      <div className="product-name">{product.fields.name}</div>
                      <div className="product-spec">è§„æ ¼: {product.fields.spec || 'æ ‡å‡†'}</div>
                      <div className="product-price">ï¿¥{parseFloat(product.fields.member_price || product.fields.price || 0).toFixed(0)}</div>
                    </div>
                    <button 
                      className="add-btn"
                      onClick={() => addProduct(product)}
                    >
                      +
                    </button>
                  </div>
                ))}
              </div>
            )}
            
            {/* è´­ç‰©è½¦ç»Ÿè®¡å’Œæ“ä½œæŒ‰é’® */}
            <div className="cart-section">
              <div className="cart-summary">
                <div className="summary-item">
                  <span className="summary-label">æ•°é‡:</span>
                  <span className="summary-value">{selectedProducts.reduce((total, product) => total + product.quantity, 0)}</span>
                </div>
                <div className="summary-item">
                  <span className="summary-label">é‡‘é¢:</span>
                  <span className="summary-value">{calculateTotal().toFixed(0)}å…ƒ</span>
                </div>
                <div className="summary-item">
                  <span className="summary-label">ä¼˜æƒ :</span>
                  <span className="summary-value">0å…ƒ</span>
                </div>
              </div>
              
              <div className="action-buttons">
                <button className="action-btn clear-btn" onClick={clearCart}>æ¸…ç©º</button>
                <button className="action-btn save-btn">æ”¶è—</button>
                <button className="action-btn checkout-btn" onClick={handleCheckout} disabled={isProcessing || !selectedMember}>
                  {isProcessing ? 'å¤„ç†ä¸­...' : 'ç»“è´¦'}
                </button>
                <button className="action-btn pending-btn">æŒ‚å•</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {/* æœç´¢ç»“æœ */}
      {searchResults.length > 0 && (
        <div className="search-results">
          {searchResults.map(member => (
            <div key={member.id} className="search-result-item" onClick={() => selectMember(member)}>
              <span>{member.fields.name}</span>
              <span>{member.fields.phone}</span>
              <span>ä½™é¢: {parseFloat(member.fields.balance || 0).toFixed(2)}å…ƒ</span>
            </div>
          ))}
        </div>
      )}
      
      {/* æ¶ˆæ¯æç¤º */}
      {message.text && (
        <div className={`message ${message.type}`}>
          {message.text}
        </div>
      )}
    </div>
  );
}

export default FrontendCashier;